<script>
    const notifications = [
        {"start_time": "16:00", "start_date": "25/02/2026", "end_time": "20:00", "end_date": "25/02/2026", "type":"warning", "message": "Library is closing at 5pm!"},
        {"start_time": "13:03", "start_date": "26/02/2026", "end_time": "13:05", "end_date": "26/02/2026", "type":"warning", "message": "Surprise"}
    ];

    let activeNotifIndex = null;

    function createNotification(notifType, notifMessage, notifID) {
        // 1. Create the warning bar element
        const warningBar = document.createElement('div');
        warningBar.className = 'warning-bar';
        warningBar.id = 'warning-bar-' + notifID;

        // 2. Set your message here
        if (notifType == "warning") {
            warningBar.innerHTML = '⚠️ <strong>Warning:</strong> ' + notifMessage ;
        }

        // 3. Insert it into the page
        const navbar = document.getElementById('navbar');
        if (navbar) {
            // This places it right after the navbar in the HTML structure
            navbar.parentNode.insertBefore(warningBar, navbar.nextSibling);
        } else {
            // Fallback if the navbar ID isn't found
            document.body.prepend(warningBar);
        }
    }

    function removeAllNotifications() {
        var paras = document.getElementsByClassName('warning-bar');

        while(paras[0]) {
            paras[0].parentNode.removeChild(paras[0]);
        }
    }

    function checkForNotifs() {

        const now = new Date();

        // Helper to convert your specific format into a JS Date object
        const parseDateTime = (dateStr, timeStr) => {
            const [day, month, year] = dateStr.split('/').map(Number);
            const [hours, minutes] = timeStr.split(':').map(Number);
            // Note: Month is 0-indexed in JS (January = 0)
            return new Date(year, month - 1, day, hours, minutes);
        };


        for (const note of notifications) {
            const noteIndex = notifications.indexOf(note);
            const start = parseDateTime(note.start_date, note.start_time);
            const end = parseDateTime(note.end_date, note.end_time);

            if (activeNotifIndex == null) {
                if (now >= start && now <= end) {
                    createNotification(note.type, note.message, noteIndex);
                    activeNotifIndex = noteIndex;
                    break;
                }
            } else if (activeNotifIndex == noteIndex) {
                if (!(now >= start && now <= end)) {
                    removeAllNotifications();
                    activeNotifIndex = null;
                    break;
                }
            }
        }
    }
    checkForNotifs();
    setInterval(checkForNotifs, 10000);

</script>

<div class="clock-container">
    <div class="clock-content">
        <div id="main-date" class="date-display">Loading date...</div>
        <div id="main-clock" class="time-display">00:00:00</div>
        <div id="status-message" class="status-display">Loading schedule...</div>
        <div id="sub-status" class="next-event-display"></div>
    </div>

    <div class="progress-container">
        <div id="time-progress" class="progress-bar"></div>
    </div>
</div>

<!-- Fullscreen when clock clicked -->
<script>
    const btn = document.getElementById('main-clock');
    btn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen(); // Request fullscreen
        } else {
            document.exitFullscreen(); // Exit fullscreen
        }
    });
</script>

<style>
/* Page Specific Styles */
.clock-container {
    height: 100vh; /* Occupy most of the screen */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    color: #F5F5F5;
    position: relative;
    padding: 0 5%;
}

    .status-display {
        font-family: 'Unbounded', sans-serif;
        font-weight: 400;
        font-size: clamp(1.5rem, 4vw, 3rem);
        margin-bottom: 1rem;
        opacity: 0.9;
    }

    /* Big Clock Font */
    .time-display {
        font-family: 'Unbounded', sans-serif;
        font-weight: 700;
        font-size: clamp(3rem, 15vw, 10rem); /* Responsive scaling for TVs */
        line-height: 1.1;
        text-shadow: 2px 2px 10px rgba(0,0,0,0.1);
    }

    /* Current Status (e.g., "Period 1") */
    .status-display {
        font-family: 'Unbounded', sans-serif;
        font-weight: 400;
        font-size: clamp(1.5rem, 4vw, 3rem);
        margin-top: 1rem;
        opacity: 0.9;
    }

    /* Countdown Text */
    .next-event-display {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; /* Readable secondary font */
        font-size: clamp(1rem, 2vw, 1.5rem);
        margin-top: 0.5rem;
        opacity: 0.7;
        font-weight: 500;
    }

    /* Progress Bar Styles */
    .progress-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 30px;
        background-color: rgba(0, 0, 0, 0.2); /* Dark track */
        z-index: 100;
    }

    .progress-bar {
        height: 100%;
        background-color: #F5F5F5; /* White bar */
        width: 0%;
        transition: width 1s linear;
        box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
</style>

<script>
    (function() {
        // --- Schedule Configuration ---
        // Format: start: "HH:MM", name: "Event Name", type: "class"|"break"|"trans"|"free"

        // Helper to generate schedule for Mon, Wed, Thu
        const getStandardDay = () => [
            { start: "07:30", end: "08:30", name: "School Open / Before P1", type: "free" },
            { start: "08:30", end: "09:35", name: "Period 1", type: "class" },
            { start: "09:35", end: "09:40", name: "Transition Time", type: "trans" },
            { start: "09:40", end: "10:45", name: "Period 2", type: "class" },
            { start: "10:45", end: "11:15", name: "Break 1", type: "break" },
            { start: "11:15", end: "12:20", name: "Period 3", type: "class" },
            { start: "12:20", end: "12:25", name: "Transition Time", type: "trans" },
            { start: "12:25", end: "13:30", name: "Period 4", type: "class" },
            { start: "13:30", end: "14:10", name: "Break 2", type: "break" },
            { start: "14:10", end: "15:15", name: "Period 5", type: "class" },
            { start: "15:15", end: "15:20", name: "Transition Time", type: "trans" },
            { start: "15:20", end: "16:35", name: "Period 6", type: "class" },
            { start: "16:35", end: "17:30", name: "Library / After School", type: "free" }
        ];

        // Tuesday Schedule
        const getTuesday = () => [
            { start: "07:30", end: "08:30", name: "School Open / Before P1", type: "free" },
            { start: "08:30", end: "09:25", name: "Period 1", type: "class" },
            { start: "09:25", end: "09:30", name: "Transition Time", type: "trans" },
            { start: "09:30", end: "10:25", name: "Period 2", type: "class" },
            { start: "10:25", end: "10:55", name: "Break 1", type: "break" },
            { start: "10:55", end: "11:50", name: "Period 3", type: "class" },
            { start: "11:50", end: "11:55", name: "Transition Time", type: "trans" },
            { start: "11:55", end: "12:50", name: "Period 4", type: "class" },
            { start: "12:50", end: "13:20", name: "Break 2", type: "break" },
            { start: "13:20", end: "14:15", name: "Period 5", type: "class" },
            { start: "14:15", end: "14:20", name: "Transition Time", type: "trans" },
            { start: "14:20", end: "15:15", name: "Period 6", type: "class" },
            { start: "15:15", end: "15:20", name: "Transition Time", type: "trans" },
            { start: "15:20", end: "16:35", name: "Period 7", type: "class" },
            { start: "16:35", end: "17:30", name: "Library / After School", type: "free" }
        ];

        // Friday Schedule
        const getFriday = () => [
            { start: "07:30", end: "08:30", name: "School Open / Before P1", type: "free" },
            { start: "08:30", end: "09:35", name: "Period 1", type: "class" },
            { start: "09:35", end: "09:40", name: "Transition Time", type: "trans" },
            { start: "09:40", end: "10:45", name: "Period 2", type: "class" },
            { start: "10:45", end: "11:15", name: "Break 1", type: "break" },
            { start: "11:15", end: "12:20", name: "Period 3", type: "class" },
            { start: "12:20", end: "12:25", name: "Transition Time", type: "trans" },
            { start: "12:25", end: "13:30", name: "Period 4", type: "class" },
            { start: "13:30", end: "14:10", name: "Break 2", type: "break" },
            { start: "14:10", end: "15:15", name: "Period 5", type: "class" },
            { start: "15:15", end: "16:00", name: "Library / After School", type: "free" } // Closes 16:00
        ];

        // Achivement conference day
        const getFifteenMinSchedule = () => {
            const schedule = [];
            const startHour = 8;
            const endHour = 16;

            // Create a reference date starting at 08:00
            let current = new Date();
            current.setHours(startHour, 0, 0, 0);

            let sessionNum = 1;

            schedule.push({ start: "07:30", end: "08:00", name: "School Open / Before P1", type: "free" }})

            // Loop until we reach 16:00
            while (current.getHours() < endHour) {
                const startTime = current.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

                // Advance 15 minutes
                current.setMinutes(current.getMinutes() + 15);

                const endTime = current.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

                schedule.push({
                    start: startTime,
                    end: endTime,
                    name: `Session ${sessionNum++}`,
                    type: "free"
                });
            }

            return schedule;
        };

        const schedules = {
            1: getStandardDay(), // Mon
            2: getTuesday(),     // Tue
            3: getStandardDay(), // Wed
            4: getStandardDay(), // Thu
            5: getFriday(),      // Fri
            6: [],               // Sat (Closed)
            0: []                // Sun (Closed)
        };

        const closingTimes = { 1: "17:30", 2: "17:30", 3: "17:30", 4: "17:30", 5: "16:00" };

        const closedDates = { // Extra dates where school is closed
            "06/02/2026": "Waitangi Day",
            "27/02/2026": "Achievement Conference Day",
            "01/04/2026": "Parent Teacher Interviews",
            "03/04/2026": "Good Friday",
        }

        function isInArray(array, value) {
            return (array.find(item => {return item == value}) || []).length > 0;
        }

        function parseTime(timeStr, dateObj) {
            const [h, m] = timeStr.split(':').map(Number);
            const d = new Date(dateObj);
            d.setHours(h, m, 0, 0);
            return d;
        }

        function formatTimeRemaining(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            if (hours > 0) return `${hours}h ${minutes}m ${seconds}s`;
            if (minutes > 0) return `${minutes}m ${seconds}s`;
            return `${seconds}s`;
        }

        function getNextDayOpen(now) {
            const next = new Date(now);
            do {
                next.setDate(next.getDate() + 1);
            } while (next.getDay() === 0 || next.getDay() === 6 || isInArray(Object.keys(closedDates), next.toLocaleDateString('en-GB')));
            next.setHours(7, 30, 0, 0);
            // If today is Monday and it's before 7:30, the math above jumps a week. Fix:
            if (now.getDay() === 1 && now.getHours() < 7) {
                next.setDate(now.getDate());
            }
            return next;
        }

        function updateClock() {
            const now = new Date();
            const day = now.getDay();
            const formattedDate = now.toLocaleDateString('en-GB');

            // Update Date
            const dateString = now.toLocaleDateString('en-GB',{
                weekday: "long",
                month: "long",
                day: "numeric"
            });
            document.getElementById('main-date').textContent = dateString;

            // Update Main Clock
            const timeString = now.toLocaleTimeString('en-GB', { hour12: false });
            document.getElementById('main-clock').textContent = timeString;

            // 2. Determine Schedule State
            let todaysSchedule = null;
            const isClosedDay = isInArray(Object.keys(closedDates), formattedDate)
            const isACD = isInArray(Object.values(closedDates), "Achievement Conference Day")
            if ( isClosedDay && isACD ) {
                todaysSchedule = getFifteenMinSchedule();
            } else {
                todaysSchedule = schedules[day];
            }
            const openTime = parseTime(todaysSchedule[0]['start'], now);
            const closeTime = parseTime(todaysSchedule[todaysSchedule.length - 1]['end'], now);
            let currentEvent = null;
            let nextEvent = null;
            let isClosed = true;
            let closedMessage = "School Closed";

            if ( isClosedDay && !(isACD)) {
                closedMessage = closedDates[formattedDate];

                // Check if within open hours for Mon-Fri
            } else if (todaysSchedule && todaysSchedule.length > 0) {

                if (now >= openTime && now < closeTime) {
                    isClosed = false;
                    // Find current slot
                    for (let i = 0; i < todaysSchedule.length; i++) {
                        const slot = todaysSchedule[i];
                        const startT = parseTime(slot.start, now);
                        const endT = parseTime(slot.end, now);

                        if (now >= startT && now < endT) {
                            currentEvent = slot;
                            currentEvent.endTimeObj = endT;
                            currentEvent.startTimeObj = startT;
                            // Look ahead for next
                            if (i + 1 < todaysSchedule.length) {
                                nextEvent = todaysSchedule[i+1];
                            }
                            break;
                        }
                    }
                }
            }

            const statusEl = document.getElementById('status-message');
            const subStatusEl = document.getElementById('sub-status');
            const progressBar = document.getElementById('time-progress');

            if (isClosed) {
                // Handle Closed State
                let targetTime;
                let targetName = "School Opens";

                // If weekday before open
                if (day >= 1 && day <= 5 && now < parseTime("07:30", now)) {
                    targetTime = parseTime("07:30", now);
                }
                // If weekday after close or weekend
                else {
                    targetTime = getNextDayOpen(now);
                }

                const msUntilOpen = targetTime - now;
                statusEl.textContent = closedMessage;
                subStatusEl.textContent = `Opens in ${formatTimeRemaining(msUntilOpen)}`;
                progressBar.style.width = "0%"; // No progress bar when closed

            } else if (currentEvent) {
                // Active School Day
                const msRemaining = currentEvent.endTimeObj - now;
                const msTotal = currentEvent.endTimeObj - currentEvent.startTimeObj;
                const percent = 100 - ((msRemaining / msTotal) * 100);

                statusEl.textContent = currentEvent.name;

                // Subtext logic
                let nextText = "";
                if (nextEvent) {
                    nextText = `Next: ${nextEvent.name}`;
                } else {
                    nextText = "School Closing Soon";
                }

                subStatusEl.textContent = `${formatTimeRemaining(msRemaining)} remaining · ${nextText}`;
                progressBar.style.width = `${percent}%`;

            } else {
                // Catch-all (should rarely hit given logic)
                statusEl.textContent = "Transition Time";
                subStatusEl.textContent = "";
                progressBar.style.width = "0%";
            }
        }

        // Run immediately and then every second
        setInterval(updateClock, 50); //didn't work: 1000 - (Date.now() % 1000));
    updateClock();
})();
</script>

<!-- RELOAD PAGE ON HASH UPDATE -->
<script>
    // Store the hash found when the page first loads
    let initialHash = null;

    async function checkForUpdates() {
      try {
        // 'no-store' ensures we get the latest file from the server, not the cache
        const response = await fetch('../hash.txt?t=' + Date.now(), { cache: 'no-store' });
        const latestHash = (await response.text()).trim();

        if (!initialHash) {
          // Set the baseline on the first run
          initialHash = latestHash;
        } else if (latestHash !== initialHash) {
          // If the hash changed, refresh the page
          console.log('New version detected. Reloading...');
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to check for updates:', error);
      }
    }

    // Check immediately on load, then every 60 seconds
    checkForUpdates();
    setInterval(checkForUpdates, 60000);
</script>
